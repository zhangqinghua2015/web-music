<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>IPTVç›´æ’­æº</title>
  <style>
    .genre-group {
      margin: 15px 0;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      transition: box-shadow 0.3s;
      font-size: xxx-large;
    }
    .genre-header {
      padding: 14px;
      background: #f8f9fa;
      cursor: pointer;
      display: flex;
      align-items: center;
    }
    .genre-header::after {
      content: 'â–¶';
      margin-left: auto;
      transition: transform 0.2s;
    }
    .genre-header.active::after {
      transform: rotate(90deg);
    }
    .channel-list {
      display: none;
      padding: 0 14px;
    }
    .channel-group {
      margin: 8px 0;
      border-left: 3px solid #2196F3;
    }
    .channel-name {
      padding: 10px;
      cursor: pointer;
      display: flex;
      align-items: center;
    }
    .url-list {
      display: none;
      padding-left: 20px;
    }
    .url-item {
      padding: 8px;
      margin: 4px 0;
      background: #f5f5f5;
      word-break: break-all;
    /*}*/
    /*.url-item {*/
        color: #2196F3;
        text-decoration: none;
        transition: all 0.2s;
    }
    .url-item:hover {
        color: #1976D2;
        text-decoration: underline;
    }
    .url-item.loading::after {
        content: 'ğŸ”„';
        margin-left: 8px;
    }
    .url-item.error {
        color: #f44336;
    }
    .config-panel {
      position: sticky; /* ç²˜æ€§å®šä½ */
      top: 0;           /* è§¦å‘å›ºå®šä½ç½®çš„æ¡ä»¶ */
      width: 100%;      /* å®½åº¦è‡ªé€‚åº”å®¹å™¨ */
      height: auto;     /* è‡ªå®šä¹‰é«˜åº¦ */
      padding: 15px;
      background: #f5f5f5;
      margin-bottom: 20px;
    }
    #sourceInput {
      height: 50px;
      font-size: xx-large;
      width: 75%;
      padding: 8px;
      margin-right: 10px;
    }
    #savedSources {
      margin-top: 10px;
      color: #666;
    }

    /* åŸºç¡€æŒ‰é’®æ ·å¼ */
    #loadCustomButton {
      width: 20%;
      height: 70px;
      font-size: xx-large;
      padding: 8px 16px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      background-image: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
      color: white;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      position: relative;
      overflow: hidden;
    }

    /* æ‚¬åœæ€å¢å¼º */
    #loadCustomButton:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
      background-image: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
    }

    /* ç‚¹å‡»åŠ¨æ•ˆ */
    #loadCustomButton:active {
      transform: translateY(1px);
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }

    /* åŠ è½½çŠ¶æ€æŒ‡ç¤º */
    #loadCustomButton.loading::after {
      content: "";
      display: inline-block;
      width: 16px;
      height: 16px;
      margin-left: 8px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 0.8s linear infinite;
    }
    #loadCustomButton:disabled {
      opacity: 0.7;
      cursor: not-allowed;
      background-image: linear-gradient(135deg, #94a3b8 0%, #64748b 100%);
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    #video-div {
      display: flex;
      justify-content: center; /* æ°´å¹³å±…ä¸­ */
      align-items: center; /* å‚ç›´å±…ä¸­ */
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
<div class="config-panel">
  <div id="video-div">
    <video id="videoPlayer" class="video-js vjs-default-skin" controls height="180"></video>
  </div>
  <input type="text" id="sourceInput"
         placeholder="åŠ è½½è‡ªå®šä¹‰IPTVæºï¼Œç¤ºä¾‹ï¼šhttps://example.com/source1.txt, https://example.com/source2.txt">
  <button id="loadCustomButton" onclick="loadCustomSource()">é‡æ–°åŠ è½½</button>
  <div id="savedSources"></div>
</div>
<div id="app"><div class="loader">åŠ è½½ä¸­...</div></div>

<!-- å¼•å…¥æ ·å¼ -->
<link href="video/video-js-cdn.min.css" rel="stylesheet">
<!-- å¼•å…¥JS -->
<script src="video/video.js"></script>
<script src="video/videojs-contrib-hls.min.js"></script>

<script>
  // æ•°æ®æºé…ç½®ï¼ˆå«å¤‡ç”¨åœ°å€ï¼‰
  const SOURCES = [
    'https://gh-proxy.com/raw.githubusercontent.com/Guovin/iptv-database/master/result.txt'
    // , 'https://ghfast.top/https://raw.githubusercontent.com/vbskycn/iptv/master/tv/iptv4.txt'
  ]
  const player = videojs('videoPlayer')

  // ç»“æ„åŒ–æ•°æ®è§£æâ€Œ:ml-citation{ref="1,4" data="citationList"}
  function parseData(text) {
    const tree = []
    let currentGroup = null

    text.split('\n').forEach(line => {
      line = line.trim()
      if (!line) return

      if (line.endsWith(',#genre#')) {
        currentGroup = {
          title: line.replace(/,#genre#/g, ''),
          channels: new Map()
        }
        tree.push(currentGroup)
      } else if (currentGroup) {
        const [name, url] = line.split(',').map(s => s.trim())
        if (name && url) {
          if (!currentGroup.channels.has(name)) {
            currentGroup.channels.set(name, [])
          }
          currentGroup.channels.get(name).push(url)
        }
      }
    })

    return tree.map(group => ({
      title: group.title,
      channels: Array.from(group.channels.entries())
    }))
  }

  // æ„å»ºDOMå…ƒç´ â€Œ:ml-citation{ref="2,4" data="citationList"}
  function createGroupElement(group) {
    const container = document.createElement('div')
    container.className = 'genre-group'

    container.innerHTML = `
        <div class="genre-header">${group.title}</div>
        <div class="channel-list"></div>
    `

    const listContainer = container.querySelector('.channel-list')
    group.channels.forEach(([name, urls]) => {
      const channelDiv = document.createElement('div')
      channelDiv.className = 'channel-group'
      channelDiv.innerHTML = `
            <div class="channel-name">${name} (${urls.length}æº)</div>
            <div class="url-list">
                ${urls.map(url => `<div class="url-item">
                  <a href="javascript:void(0);"
                     class="url-item"
                     rel="noopener noreferrer" onclick="playTV('${url}')">
                      ${url}
                  </a>
                </div>`).join('')}
            </div>
        `
      listContainer.appendChild(channelDiv)
    })

    // ç»‘å®šäº¤äº’äº‹ä»¶â€Œ:ml-citation{ref="2" data="citationList"}
    container.querySelector('.genre-header').addEventListener('click', function() {
      this.classList.toggle('active')
      this.nextElementSibling.style.display =
              this.classList.contains('active') ? 'block' : 'none'
    })

    // å­é¢‘é“äº¤äº’ç»‘å®š
    container.querySelectorAll('.channel-name').forEach(header => {
      header.addEventListener('click', function() {
        this.classList.toggle('active')
        this.nextElementSibling.style.display =
                this.classList.contains('active') ? 'block' : 'none'
      })
    })

    return container
  }

  // åˆå§‹åŒ–åŠ è½½â€Œ:ml-citation{ref="3,6" data="citationList"}
  async function init(urls) {
    try {

      const response = urls ? await fetchWithRetry(urls) : await fetchWithRetry(SOURCES)
      const data = parseData(response)

      const app = document.getElementById('app')
      app.innerHTML = ''
      data.forEach(group => {
        app.appendChild(createGroupElement(group))
      })

    } catch (error) {
      app.innerHTML = `<div style="color:red">æ•°æ®åŠ è½½å¤±è´¥: ${error.message}</div>`
    }
  }

  // å®¹ç¾è¯·æ±‚æ–¹æ³•â€Œ:ml-citation{ref="3" data="citationList"}
  async function fetchWithRetry(urls) {
    for (const url of urls) {
      try {
        console.log(url)
        const resp = await fetch(url)
        if (resp.ok) return await resp.text()
      } catch (e) {
        console.warn(`è¯·æ±‚å¤±è´¥: ${url}`)
      }
    }
    throw new Error('æ‰€æœ‰æ•°æ®æºä¸å¯ç”¨')
  }

  // ä¿å­˜æ•°æ®æºåˆ°localStorage
  function saveSources(urls) {
    localStorage.setItem('customIPTVSource', JSON.stringify(urls))
  }

  // åŠ è½½å†å²æ•°æ®æº
  function loadSavedSources() {
    const saved = localStorage.getItem('customIPTVSource')
    return saved ? JSON.parse(saved) : []
  }

  // æ›´æ–°å·²ä¿å­˜æ˜¾ç¤º
  function updateSavedDisplay(urls) {
    const display = urls.map(url =>
            `<div>âœ“ ${url} <button onclick="removeSource('${url}')">ç§»é™¤</button></div>`
    ).join('')
    document.getElementById('savedSources').innerHTML = display
  }

  // ç§»é™¤å•ä¸ªæ•°æ®æº
  function removeSource(url) {
    const updated = loadSavedSources().filter(u => u !== url)
    saveSources(updated)
    updateSavedDisplay(updated)
  }

  // ç”¨æˆ·è§¦å‘åŠ è½½
  function loadCustomSource() {
    const input = document.getElementById('sourceInput')
    if (!input.value) {
      init()
      return
    }
    const urls = input.value.split(',').map(url => url.trim()).filter(Boolean)
    saveSources(urls)
    init(urls)
  }

  // æ’­æ”¾
  function playTV(url) {
    player.src({src: url, type: 'application/x-mpegURL'})
    player.load()  // å¼ºåˆ¶é‡æ–°åŠ è½½è§†é¢‘ â€Œ:ml-citation{ref="4,6" data="citationList"}
    player.play()
  }

  // åˆå§‹åŒ–åŠ è½½å†å²æ•°æ®
  document.addEventListener('DOMContentLoaded', () => {
    const saved = loadSavedSources()
    if (saved.length) {
      document.getElementById('sourceInput').value = saved.join(', ')
      updateSavedDisplay(saved)
      init(saved)
    } else {
      // å¯åŠ¨åº”ç”¨
      init()
    }

  })

</script>
</body>
</html>
